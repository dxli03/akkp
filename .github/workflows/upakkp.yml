name: Auto Update Worker JS # å·¥ä½œæµç¨‹åç§°

on:
  push:
    branches:
      - main # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write # éœ€è¦å†™å…¥æƒé™æ¥æäº¤æ›´æ”¹

jobs:
  update:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„ ubuntu ç¯å¢ƒè¿è¡Œ
    outputs: # å®šä¹‰è¾“å‡ºï¼Œç”¨äºæäº¤æ¶ˆæ¯
      new_version_sha: ${{ steps.check_update.outputs.new_sha }}
    steps:
      - name: æ£€å‡ºä»“åº“ # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä½ è‡ªå·±çš„ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒ # ç¬¬äºŒæ­¥ï¼šè®¾ç½®åç»­æ­¥éª¤éœ€è¦çš„ç¯å¢ƒå˜é‡
        run: |
          echo "SOURCE_REPO_OWNER=yonggekkk" >> $GITHUB_ENV # æºä»“åº“çš„æ‰€æœ‰è€…
          echo "SOURCE_REPO_NAME=Cloudflare_vless_trojan" >> $GITHUB_ENV # æºä»“åº“çš„åç§°
          echo "SOURCE_FILE_PATH=Vless_workers_pages/_worker.js" >> $GITHUB_ENV # æºæ–‡ä»¶åœ¨ä»“åº“ä¸­çš„è·¯å¾„
          echo "SOURCE_BRANCH=main" >> $GITHUB_ENV # æºæ–‡ä»¶æ‰€åœ¨çš„åˆ†æ”¯
          echo "TARGET_FILE=_worker.js" >> $GITHUB_ENV # è¦æ›´æ–°åˆ°ä½ ä»“åº“çš„ç›®æ ‡æ–‡ä»¶å
          echo "VERSION_FILE=worker_js_version.txt" >> $GITHUB_ENV # ç”¨äºå­˜å‚¨å½“å‰ JS æ–‡ä»¶ SHA çš„ç‰ˆæœ¬æ–‡ä»¶å

      - name: æ£€æŸ¥å¹¶æ›´æ–° Worker JS # ç¬¬ä¸‰æ­¥ï¼šæ ¸å¿ƒé€»è¾‘ï¼Œæ£€æŸ¥å¹¶æ›´æ–° JS æ–‡ä»¶
        id: check_update # ç»™è¿™ä¸ªæ­¥éª¤è®¾ç½®ä¸€ä¸ª IDï¼Œæ–¹ä¾¿åç»­å¼•ç”¨å…¶è¾“å‡º
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GitHub æä¾›çš„ GITHUB_TOKEN è¿›è¡Œ API è®¤è¯
        run: |
          # æ—¥å¿—å‡½æ•°ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ—¶é—´æˆ³
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          log "å¼€å§‹æ£€æŸ¥æ›´æ–° $TARGET_FILE..."

          # æ„å»º GitHub Contents API URL
          API_URL="https://api.github.com/repos/$SOURCE_REPO_OWNER/$SOURCE_REPO_NAME/contents/$SOURCE_FILE_PATH?ref=$SOURCE_BRANCH"
          log "API URL: $API_URL"

          # è·å–æœ¬åœ°å­˜å‚¨çš„ SHA ç‰ˆæœ¬å·
          LOCAL_SHA=$(cat $VERSION_FILE 2>/dev/null || echo "") # å¦‚æœ version æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œåˆ™ LOCAL_SHA ä¸ºç©º
          log "æœ¬åœ° SHA: ${LOCAL_SHA:-æ— }" # å¦‚æœ LOCAL_SHA ä¸ºç©ºï¼Œåˆ™æ‰“å° "æ— "

          # è·å–æœ€æ–°çš„æ–‡ä»¶ä¿¡æ¯
          log "è·å–æœ€æ–°æ–‡ä»¶ä¿¡æ¯..."
          RESPONSE=$(curl -s --retry 3 -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$API_URL")

          if [ $? -ne 0 ]; then # æ£€æŸ¥ curl å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œ
            log "é”™è¯¯ï¼šæ— æ³•è®¿é—® GitHub API è·å–æ–‡ä»¶ä¿¡æ¯"
            exit 1 # å¼‚å¸¸é€€å‡º
          fi

          # æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«é”™è¯¯æ¶ˆæ¯ (ä¾‹å¦‚æ–‡ä»¶æœªæ‰¾åˆ°)
          if echo "$RESPONSE" | jq -e '.message' > /dev/null; then # ä½¿ç”¨ jq æ£€æŸ¥ JSON ä¸­æ˜¯å¦å­˜åœ¨ message å­—æ®µ
            ERROR_MESSAGE=$(echo "$RESPONSE" | jq -r '.message')
            log "é”™è¯¯ï¼šGitHub API è¿”å›é”™è¯¯: $ERROR_MESSAGE"
            exit 1 # å¼‚å¸¸é€€å‡º
          fi

          REMOTE_SHA=$(echo "$RESPONSE" | jq -r '.sha') # ä» API å“åº”ä¸­æå–æ–‡ä»¶çš„ SHA
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.download_url') # ä» API å“åº”ä¸­æå–æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥

          if [ -z "$REMOTE_SHA" ] || [ "$REMOTE_SHA" == "null" ]; then # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å– SHA
            log "é”™è¯¯ï¼šæœªèƒ½ä» API å“åº”ä¸­è·å–æ–‡ä»¶ SHA"
            echo "API Response: $RESPONSE" # æ‰“å°å®Œæ•´çš„ API å“åº”ä»¥ä¾¿è°ƒè¯•
            exit 1 # å¼‚å¸¸é€€å‡º
          fi

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–ä¸‹è½½é“¾æ¥
            log "é”™è¯¯ï¼šæœªèƒ½ä» API å“åº”ä¸­è·å–ä¸‹è½½é“¾æ¥ ($TARGET_FILE)"
            echo "API Response: $RESPONSE" # æ‰“å°å®Œæ•´çš„ API å“åº”ä»¥ä¾¿è°ƒè¯•
            exit 1 # å¼‚å¸¸é€€å‡º
          fi
          log "æœ€æ–° SHA: $REMOTE_SHA"
          echo "::set-output name=new_sha::$REMOTE_SHA" # è®¾ç½®è¾“å‡ºå˜é‡ new_shaï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨

          # åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }} # è·å–æ‰‹åŠ¨è§¦å‘æ—¶è¾“å…¥çš„ force_update å‚æ•°
          if [ "$LOCAL_SHA" = "$REMOTE_SHA" ] && [ "$FORCE_UPDATE" != "true" ]; then # å¦‚æœæœ¬åœ° SHA å’Œè¿œç¨‹ SHA ç›¸åŒï¼Œå¹¶ä¸”ä¸æ˜¯å¼ºåˆ¶æ›´æ–°
            log "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ (SHA: $LOCAL_SHA)ï¼Œæ— éœ€æ›´æ–°"
            exit 0 # æ­£å¸¸é€€å‡ºï¼Œæ— éœ€æ‰§è¡Œåç»­æ“ä½œ
          fi

          # ä¸‹è½½å¹¶æ›´æ–°æ–‡ä»¶
          log "ä¸‹è½½ $TARGET_FILE ä» $DOWNLOAD_URL..."
          wget -q -O "$TARGET_FILE" "$DOWNLOAD_URL" # ä½¿ç”¨ wget ä¸‹è½½æ–‡ä»¶ï¼Œ-q å®‰é™æ¨¡å¼ï¼Œ-O æŒ‡å®šè¾“å‡ºæ–‡ä»¶å
          if [ $? -ne 0 ]; then # æ£€æŸ¥ wget æ˜¯å¦æˆåŠŸ
            log "é”™è¯¯ï¼šä¸‹è½½ $TARGET_FILE å¤±è´¥"
            exit 1 # å¼‚å¸¸é€€å‡º
          fi

          echo "$REMOTE_SHA" > $VERSION_FILE # å°†æ–°çš„ SHA å†™å…¥ç‰ˆæœ¬æ–‡ä»¶
          log "æ›´æ–°å®Œæˆï¼Œæ–° SHA: $REMOTE_SHA"

      - name: æäº¤æ›´æ”¹ # ç¬¬å››æ­¥ï¼šå¦‚æœæ–‡ä»¶æœ‰æ›´æ–°ï¼Œåˆ™æäº¤æ›´æ”¹åˆ°ä½ çš„ä»“åº“
        if: success() && steps.check_update.outputs.new_sha != '' # ä»…åœ¨å‰ä¸€æ­¥æˆåŠŸä¸”è·å–åˆ°æ–° SHA æ—¶æ‰§è¡Œ
        uses: stefanzweifel/git-auto-commit-action@v5 # ä½¿ç”¨ä¸€ä¸ªæµè¡Œçš„è‡ªåŠ¨æäº¤ Action
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker JS: SHA ${{ steps.check_update.outputs.new_sha }}" # æäº¤ä¿¡æ¯ï¼ŒåŒ…å«æ–°çš„ SHA
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>" # æäº¤ä½œè€…ä¿¡æ¯
          file_pattern: ${{ env.TARGET_FILE }} ${{ env.VERSION_FILE }} # æŒ‡å®šè¦æäº¤çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ›´æ–°çš„ JS æ–‡ä»¶å’Œç‰ˆæœ¬æ–‡ä»¶
